<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ­Ù„ÛŒÙ„ Ù¾ÙˆÛŒØ§ÛŒ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Neutrals -->
    <!-- Application Structure Plan: The application now follows a task-oriented flow. 1) User uploads a file. 2) User initiates analysis. 3) App shows a loading state. 4) App displays the interactive dashboard with results. A reset button was added to allow the user to easily start a new analysis, returning them to step 1 without a page reload. This improves the usability of the tool for multiple analyses. -->
    <!-- Visualization & Content Choices: 
        1. Report Info: User-provided thesis titles from an Excel file. -> Goal: Input/Interact. -> Presentation: File Input + Button. -> Justification: Standard and universally understood method for file uploads. -> Method: HTML + JS FileReader API.
        2. Report Info: Analysis process. -> Goal: Inform. -> Presentation: Loading Spinner. -> Justification: Provides crucial feedback to the user that the application is working. -> Method: HTML/CSS.
        3. Report Info: AI-driven analysis (simulated). -> Goal: Analyze/Organize. -> Presentation: A JS function using keyword heuristics. -> Justification: Simulates the requested AI analysis within frontend constraints, providing immediate, rule-based categorization. -> Method: Vanilla JS.
        4. Report Info: Reset functionality. -> Goal: Interact. -> Presentation: Reset Button. -> Justification: Provides a clear way for users to restart the process. -> Method: HTML + JS.
        5. All other visualizations (Charts, Table, Download) remain the same but are now populated with dynamically analyzed data, making the entire dashboard a responsive and personalized tool.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #F8F7F4;
            color: #4A4A4A;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 350px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
                max-height: 400px;
            }
        }
        .card {
            background-color: #FFFFFF;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        .action-btn {
            background-color: #A68E6A;
            color: #FFFFFF;
            font-weight: 700;
            border-radius: 8px;
            padding: 12px 24px;
            transition: background-color 0.3s, transform 0.3s;
        }
        .action-btn:hover {
            background-color: #8c7658;
            transform: scale(1.05);
        }
        .action-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .filter-btn {
            background-color: #EAE8E1;
            color: #5D5D5D;
            font-weight: 700;
            border-radius: 8px;
            padding: 8px 16px;
            transition: background-color 0.3s, color 0.3s;
            display: inline-flex;
            align-items: center;
        }
        .filter-btn:hover, .filter-btn.active {
            background-color: #A68E6A;
            color: #FFFFFF;
        }
        .reset-btn {
            background-color: #f5d0d0;
            color: #9b2c2c;
        }
        .reset-btn:hover {
            background-color: #ef4444;
            color: white;
        }
        thead th {
            background-color: #F3F1EC;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #A68E6A;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .file-input-label {
            border: 2px dashed #A68E6A;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .file-input-label:hover {
            background-color: #F3F1EC;
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-[#A68E6A]">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªØ­Ù„ÛŒÙ„ Ù¾ÙˆÛŒØ§ÛŒ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§</h1>
            <p class="mt-2 text-lg text-gray-600">ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯ ØªØ§ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¢Ù† ØªÙˆØ³Ø· Ù…Ø¯Ù„ Ù‡ÙˆØ´Ù…Ù†Ø¯ ØªØ­Ù„ÛŒÙ„ Ø´ÙˆØ¯</p>
        </header>

        <main>
            <section id="upload-section" class="card p-6 mb-8 text-center">
                <h2 class="text-2xl font-bold text-[#A68E6A] mb-4">Û±. Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ÙØ§ÛŒÙ„</h2>
                <p class="text-gray-600 mb-6">ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ (.xlsx) Ø­Ø§ÙˆÛŒ Ø¹Ù†Ø§ÙˆÛŒÙ† Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯. ÙØ§ÛŒÙ„ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø³ØªÙˆÙ† Ø¨Ø§ Ù†Ø§Ù… "Ø¹Ù†ÙˆØ§Ù†" Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯.</p>
                
                <label for="excel-file-input" class="file-input-label block">
                    <span id="file-name-display">ÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯ ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</span>
                </label>
                <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                
                <button id="analyze-btn" class="action-btn mt-6" disabled>
                    <span class="ml-2">ğŸ”¬</span>
                    Ø´Ø±ÙˆØ¹ ØªØ­Ù„ÛŒÙ„
                </button>
            </section>

            <div id="loader-section" class="text-center p-8 hidden">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-lg font-bold text-gray-700">Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯.</p>
            </div>

            <div id="dashboard-content" class="hidden">
                <div class="mb-8 flex justify-center flex-wrap gap-3" id="filter-buttons">
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card p-4">
                        <h2 class="text-xl font-bold text-center mb-4 text-gray-700">ØªÙˆØ²ÛŒØ¹ Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù„Ù…ÛŒ</h2>
                        <div class="chart-container">
                            <canvas id="fieldDistributionChart"></canvas>
                        </div>
                    </div>
                    <div class="card p-4">
                        <h2 class="text-xl font-bold text-center mb-4 text-gray-700">Ù…Ù‚Ø§ÛŒØ³Ù‡ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ</h2>
                        <div class="chart-container">
                            <canvas id="commercializationChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card p-4 sm:p-6">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                        <h2 class="text-2xl font-bold text-[#A68E6A]">Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§</h2>
                        <div class="flex gap-2">
                             <button id="reset-btn" class="filter-btn reset-btn">
                                <span class="ml-2">ğŸ”„</span>
                                Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ
                            </button>
                            <button id="download-excel-btn" class="filter-btn">
                                <span class="ml-2">ğŸ“¥</span>
                                Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ú©Ø³Ù„
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-right">
                            <thead class="font-bold">
                                <tr>
                                    <th scope="col" class="p-3">Ø¹Ù†ÙˆØ§Ù† Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡</th>
                                    <th scope="col" class="p-3">Ø­ÙˆØ²Ù‡ Ø¹Ù„Ù…ÛŒ Ø§ØµÙ„ÛŒ</th>
                                    <th scope="col" class="p-3">Ù‚Ø§Ø¨Ù„ÛŒØª ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ</th>
                                    <th scope="col" class="p-3">Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù‡Ù…Ú©Ø§Ø±ÛŒ</th>
                                </tr>
                            </thead>
                            <tbody id="thesis-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-center mt-12 py-4 border-t border-gray-200">
            <p class="text-gray-500">Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ­Ù„ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ú˜ÙˆÙ‡Ø´ÛŒ</p>
        </footer>
    </div>

    <script>
        const uploadSection = document.getElementById('upload-section');
        const loaderSection = document.getElementById('loader-section');
        const dashboardContent = document.getElementById('dashboard-content');
        const fileInput = document.getElementById('excel-file-input');
        const analyzeBtn = document.getElementById('analyze-btn');
        const fileNameDisplay = document.getElementById('file-name-display');
        
        const tableBody = document.getElementById('thesis-table-body');
        const filterButtonsContainer = document.getElementById('filter-buttons');
        const downloadBtn = document.getElementById('download-excel-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        let fieldDistributionChart, commercializationChart;
        let analyzedData = [];

        const commercializationMap = {
            'Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§': 3,
            'Ø¨Ø§Ù„Ø§': 2.5,
            'Ù…ØªÙˆØ³Ø· ØªØ§ Ø¨Ø§Ù„Ø§': 2,
            'Ù…ØªÙˆØ³Ø·': 1.5,
            'Ù¾Ø§ÛŒÛŒÙ†': 1,
            'Ù†Ø§Ù…Ø´Ø®Øµ': 0.5
        };

        const colors = {
            'Ù†Ø§Ù†ÙˆØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ Ø¯Ø§Ø±ÙˆÛŒÛŒ': 'rgba(166, 142, 106, 0.8)',
            'Ø¯Ø§Ø±ÙˆØ±Ø³Ø§Ù†ÛŒ Ù‡Ø¯ÙÙ…Ù†Ø¯': 'rgba(204, 182, 142, 0.8)',
            'Ø´ÛŒÙ…ÛŒ Ø¯Ø§Ø±ÙˆÛŒÛŒ': 'rgba(189, 171, 130, 0.8)',
            'ÙØ§Ø±Ù…Ø§Ø³ÛŒÙˆØªÛŒÚ©Ø³': 'rgba(224, 211, 184, 0.8)',
            'Ù…ÛŒÚ©Ø±ÙˆØ¨ÛŒÙˆÙ„ÙˆÚ˜ÛŒ Ø¯Ø§Ø±ÙˆÛŒÛŒ': 'rgba(201, 192, 174, 0.8)',
            'ÙØ§Ø±Ù…Ø§Ú©ÙˆÚ¯Ù†ÙˆØ²ÛŒ': 'rgba(179, 163, 136, 0.8)',
            'ØªØ­Ù‚ÛŒÙ‚Ø§Øª Ø¨Ø§Ù„ÛŒÙ†ÛŒ': 'rgba(158, 158, 158, 0.8)',
            'Ø¨ÛŒÙˆØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ Ø¯Ø§Ø±ÙˆÛŒÛŒ': 'rgba(141, 110, 99, 0.8)',
            'Ù†Ø§Ù…Ø´Ø®Øµ': 'rgba(211, 211, 211, 0.8)'
        };
        
        const borderColors = {
            'Ù†Ø§Ù†ÙˆØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ Ø¯Ø§Ø±ÙˆÛŒÛŒ': 'rgba(166, 142, 106, 1)',
            'Ø¯Ø§Ø±ÙˆØ±Ø³Ø§Ù†ÛŒ Ù‡Ø¯ÙÙ…Ù†Ø¯': 'rgba(204, 182, 142, 1)',
            'Ø´ÛŒÙ…ÛŒ Ø¯Ø§Ø±ÙˆÛŒÛŒ': 'rgba(189, 171, 130, 1)',
            'ÙØ§Ø±Ù…Ø§Ø³ÛŒÙˆØªÛŒÚ©Ø³': 'rgba(224, 211, 184, 1)',
            'Ù…ÛŒÚ©Ø±ÙˆØ¨ÛŒÙˆÙ„ÙˆÚ˜ÛŒ Ø¯Ø§Ø±ÙˆÛŒÛŒ': 'rgba(201, 192, 174, 1)',
            'ÙØ§Ø±Ù…Ø§Ú©ÙˆÚ¯Ù†ÙˆØ²ÛŒ': 'rgba(179, 163, 136, 1)',
            'ØªØ­Ù‚ÛŒÙ‚Ø§Øª Ø¨Ø§Ù„ÛŒÙ†ÛŒ': 'rgba(158, 158, 158, 1)',
            'Ø¨ÛŒÙˆØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ Ø¯Ø§Ø±ÙˆÛŒÛŒ': 'rgba(141, 110, 99, 1)',
            'Ù†Ø§Ù…Ø´Ø®Øµ': 'rgba(211, 211, 211, 1)'
        };

        function simulateAiAnalysis(title) {
            const lowerTitle = title.toLowerCase();
            let field = 'Ù†Ø§Ù…Ø´Ø®Øµ';
            let commercialization = 'Ù…ØªÙˆØ³Ø·';
            let collaboration = 'Ù…Ø±Ø§Ú©Ø² ØªØ­Ù‚ÛŒÙ‚Ø§ØªÛŒ Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ';

            if (lowerTitle.includes('Ù†Ø§Ù†Ùˆ')) {
                field = 'Ù†Ø§Ù†ÙˆØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ Ø¯Ø§Ø±ÙˆÛŒÛŒ';
                commercialization = 'Ø¨Ø§Ù„Ø§';
                collaboration = 'Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù†ÙˆØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ Ùˆ Ø¯Ø§Ø±ÙˆØ³Ø§Ø²ÛŒ';
            } else if (lowerTitle.includes('Ø³Ù†ØªØ²') || lowerTitle.includes('Ù…Ø´ØªÙ‚Ø§Øª')) {
                field = 'Ø´ÛŒÙ…ÛŒ Ø¯Ø§Ø±ÙˆÛŒÛŒ';
                commercialization = 'Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§';
                collaboration = 'ÙˆØ§Ø­Ø¯Ù‡Ø§ÛŒ R&D Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø±ÙˆØ³Ø§Ø²ÛŒ';
            } else if (lowerTitle.includes('ÙØ±Ù…ÙˆÙ„Ø§Ø³ÛŒÙˆÙ†') || lowerTitle.includes('Ù¾Ú†') || lowerTitle.includes('Ù‚Ø±Øµ') || lowerTitle.includes('Ø¢Ù‡Ø³ØªÙ‡â€ŒØ±Ù‡Ø´')) {
                field = 'ÙØ§Ø±Ù…Ø§Ø³ÛŒÙˆØªÛŒÚ©Ø³';
                commercialization = 'Ù…ØªÙˆØ³Ø· ØªØ§ Ø¨Ø§Ù„Ø§';
                collaboration = 'Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ø¯Ø§Ø±Ùˆ';
            } else if (lowerTitle.includes('Ú¯ÛŒØ§Ù‡') || lowerTitle.includes('Ø¹ØµØ§Ø±Ù‡')) {
                field = 'ÙØ§Ø±Ù…Ø§Ú©ÙˆÚ¯Ù†ÙˆØ²ÛŒ';
                commercialization = 'Ù…ØªÙˆØ³Ø·';
                collaboration = 'Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ø´â€ŒØ¨Ù†ÛŒØ§Ù† Ùˆ ØªÙˆÙ„ÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡ Ø¯Ø§Ø±ÙˆÙ‡Ø§ÛŒ Ú¯ÛŒØ§Ù‡ÛŒ';
            } else if (lowerTitle.includes('Ù…ÛŒÚ©Ø±ÙˆØ¨') || lowerTitle.includes('Ø¢Ù†ØªÛŒâ€ŒØ¨ÛŒÙˆØªÛŒÚ©') || lowerTitle.includes('Ù…Ù‚Ø§ÙˆÙ…Øª')) {
                field = 'Ù…ÛŒÚ©Ø±ÙˆØ¨ÛŒÙˆÙ„ÙˆÚ˜ÛŒ Ø¯Ø§Ø±ÙˆÛŒÛŒ';
                commercialization = 'Ù¾Ø§ÛŒÛŒÙ†';
                collaboration = 'Ø¨ÛŒÙ…Ø§Ø±Ø³ØªØ§Ù†â€ŒÙ‡Ø§ Ùˆ ÙˆØ²Ø§Ø±Øª Ø¨Ù‡Ø¯Ø§Ø´Øª';
            } else if (lowerTitle.includes('Ù‡Ø¯ÙÙ…Ù†Ø¯')) {
                field = 'Ø¯Ø§Ø±ÙˆØ±Ø³Ø§Ù†ÛŒ Ù‡Ø¯ÙÙ…Ù†Ø¯';
                commercialization = 'Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§';
                collaboration = 'Ø§Ø³ØªØ§Ø±ØªØ§Ù¾â€ŒÙ‡Ø§ÛŒ Ø¨ÛŒÙˆØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ Ùˆ Ø´Ø±Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ Ø¯Ø§Ø±ÙˆØ³Ø§Ø²ÛŒ';
            } else if (lowerTitle.includes('Ø¨Ø§Ù„ÛŒÙ†ÛŒ') || lowerTitle.includes('Ø¨ÛŒÙ…Ø§Ø±Ø§Ù†')) {
                field = 'ØªØ­Ù‚ÛŒÙ‚Ø§Øª Ø¨Ø§Ù„ÛŒÙ†ÛŒ';
                commercialization = 'Ù¾Ø§ÛŒÛŒÙ†';
                collaboration = 'Ù…Ø±Ø§Ú©Ø² Ø¯Ø±Ù…Ø§Ù†ÛŒ Ùˆ Ø³Ø§Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø¨Ù‡Ø¯Ø§Ø´ØªÛŒ';
            }

            if (lowerTitle.includes('Ø³Ø±Ø·Ø§Ù†') || lowerTitle.includes('Ø¢Ù„Ø²Ø§ÛŒÙ…Ø±') || lowerTitle.includes('Ø¯ÛŒØ§Ø¨Øª')) {
                 if (commercializationMap[commercialization] < commercializationMap['Ø¨Ø§Ù„Ø§']) {
                    commercialization = 'Ø¨Ø§Ù„Ø§';
                 }
            }

            return { title, field, commercialization, collaboration };
        }

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                const fileName = fileInput.files[0].name;
                fileNameDisplay.textContent = `ÙØ§ÛŒÙ„ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡: ${fileName}`;
                analyzeBtn.disabled = false;
            } else {
                fileNameDisplay.textContent = 'ÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯ ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯';
                analyzeBtn.disabled = true;
            }
        });

        analyzeBtn.addEventListener('click', () => {
            const file = fileInput.files[0];
            if (!file) return;

            uploadSection.classList.add('hidden');
            loaderSection.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const json = XLSX.utils.sheet_to_json(worksheet);

                analyzedData = [];
                if (json.length > 0 && ('Ø¹Ù†ÙˆØ§Ù†' in json[0] || 'Title' in json[0])) {
                     json.forEach(row => {
                        const title = row['Ø¹Ù†ÙˆØ§Ù†'] || row['Title'];
                        if (title) {
                            analyzedData.push(simulateAiAnalysis(title));
                        }
                    });
                } else {
                    alert('ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¨Ø§ÛŒØ¯ Ø¯Ø§Ø±Ø§ÛŒ Ø³ØªÙˆÙ†ÛŒ Ø¨Ø§ Ù†Ø§Ù… "Ø¹Ù†ÙˆØ§Ù†" ÛŒØ§ "Title" Ø¨Ø§Ø´Ø¯.');
                    resetApplication();
                    return;
                }
                
                setTimeout(() => { // Simulate processing time
                    loaderSection.classList.add('hidden');
                    dashboardContent.classList.remove('hidden');
                    initializeDashboard();
                }, 1500);
            };
            reader.readAsArrayBuffer(file);
        });

        function initializeDashboard() {
            renderTable(analyzedData);
            createFieldDistributionChart(analyzedData);
            createCommercializationChart(analyzedData);
            renderFilterButtons();
        }
        
        function renderFilterButtons() {
            filterButtonsContainer.innerHTML = '';
            const fields = [...new Set(analyzedData.map(item => item.field))];
            let buttonsHTML = '<button class="filter-btn active" data-filter="all">Ù‡Ù…Ù‡ Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§</button>';
            fields.forEach(field => {
                buttonsHTML += `<button class="filter-btn" data-filter="${field}">${field}</button>`;
            });
            filterButtonsContainer.innerHTML = buttonsHTML;
        }

        function renderTable(data) {
            tableBody.innerHTML = '';
            if (data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">Ù‡ÛŒÚ† Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</td></tr>`;
                return;
            }
            data.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-3">${item.title}</td>
                    <td class="p-3">${item.field}</td>
                    <td class="p-3"><span class="font-bold">${item.commercialization}</span></td>
                    <td class="p-3">${item.collaboration}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function createFieldDistributionChart(data) {
            const ctx = document.getElementById('fieldDistributionChart').getContext('2d');
            const fieldCounts = data.reduce((acc, item) => {
                acc[item.field] = (acc[item.field] || 0) + 1;
                return acc;
            }, {});

            const chartData = {
                labels: Object.keys(fieldCounts),
                datasets: [{
                    label: 'ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§',
                    data: Object.values(fieldCounts),
                    backgroundColor: Object.keys(fieldCounts).map(field => colors[field] || colors.default),
                    borderColor: Object.keys(fieldCounts).map(field => borderColors[field] || borderColors.default),
                    borderWidth: 1
                }]
            };

            if (fieldDistributionChart) fieldDistributionChart.destroy();
            fieldDistributionChart = new Chart(ctx, { type: 'doughnut', data: chartData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top', labels: { font: { family: 'Vazirmatn' }}}, tooltip: { bodyFont: { family: 'Vazirmatn' }, titleFont: { family: 'Vazirmatn' }}}, onClick: (e, el) => { if(el.length > 0) { const label = fieldDistributionChart.data.labels[el[0].index]; filterData(label); updateActiveButton(label); }}}});
        }

        function createCommercializationChart(data) {
            const ctx = document.getElementById('commercializationChart').getContext('2d');
            const commercializationData = data.reduce((acc, item) => {
                const score = commercializationMap[item.commercialization] || 0;
                if (!acc[item.field]) {
                     acc[item.field] = { sum: 0, count: 0 };
                }
                acc[item.field].sum += score;
                acc[item.field].count++;
                return acc;
            }, {});

            const avgScores = Object.keys(commercializationData).map(field => ({
                field: field,
                avgScore: commercializationData[field].sum / commercializationData[field].count
            })).sort((a, b) => b.avgScore - a.avgScore);

            const chartData = {
                labels: avgScores.map(item => item.field),
                datasets: [{
                    label: 'Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ù¾ØªØ§Ù†Ø³ÛŒÙ„ ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ (Ø§Ø² Û³)',
                    data: avgScores.map(item => item.avgScore),
                    backgroundColor: avgScores.map(item => colors[item.field] || colors.default),
                    borderColor: avgScores.map(item => borderColors[item.field] || borderColors.default),
                    borderWidth: 1
                }]
            };

            if (commercializationChart) commercializationChart.destroy();
            commercializationChart = new Chart(ctx, { type: 'bar', data: chartData, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { font: { family: 'Vazirmatn' }}}, y: { ticks: { font: { family: 'Vazirmatn' }}}}, plugins: { legend: { display: false }, tooltip: { bodyFont: { family: 'Vazirmatn' }, titleFont: { family: 'Vazirmatn' }}} }});
        }
        
        function getFilteredData() {
            const currentFilter = document.querySelector('#filter-buttons .filter-btn.active')?.dataset.filter || 'all';
            if (currentFilter === 'all') {
                return analyzedData;
            }
            return analyzedData.filter(item => item.field === currentFilter);
        }

        function filterData(filter) {
            const data = (filter === 'all') ? analyzedData : analyzedData.filter(item => item.field === filter);
            renderTable(data);
            createFieldDistributionChart(data);
            createCommercializationChart(data);
        }

        function updateActiveButton(filter) {
            const buttons = filterButtonsContainer.querySelectorAll('.filter-btn');
            buttons.forEach(button => {
                button.classList.toggle('active', button.dataset.filter === filter);
            });
        }
        
        function downloadExcel() {
            const dataToExport = getFilteredData();
            const headers = { title: 'Ø¹Ù†ÙˆØ§Ù† Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡', field: 'Ø­ÙˆØ²Ù‡ Ø¹Ù„Ù…ÛŒ Ø§ØµÙ„ÛŒ', commercialization: 'Ù‚Ø§Ø¨Ù„ÛŒØª ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ', collaboration: 'Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù‡Ù…Ú©Ø§Ø±ÛŒ' };
            const worksheetData = dataToExport.map(item => ({
                [headers.title]: item.title,
                [headers.field]: item.field,
                [headers.commercialization]: item.commercialization,
                [headers.collaboration]: item.collaboration
            }));

            const worksheet = XLSX.utils.json_to_sheet(worksheetData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "ØªØ­Ù„ÛŒÙ„ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§");
            worksheet['!cols'] = [ { wch: 70 }, { wch: 25 }, { wch: 20 }, { wch: 50 } ];
            XLSX.writeFile(workbook, "ØªØ­Ù„ÛŒÙ„_Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§.xlsx");
        }

        function resetApplication() {
            dashboardContent.classList.add('hidden');
            loaderSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');

            analyzedData = [];
            fileInput.value = '';
            fileNameDisplay.textContent = 'ÙØ§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ú©Ø´ÛŒØ¯ ÛŒØ§ Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯';
            analyzeBtn.disabled = true;

            if (fieldDistributionChart) {
                fieldDistributionChart.destroy();
                fieldDistributionChart = null;
            }
            if (commercializationChart) {
                commercializationChart.destroy();
                commercializationChart = null;
            }

            tableBody.innerHTML = '';
            filterButtonsContainer.innerHTML = '';
        }

        filterButtonsContainer.addEventListener('click', (e) => {
            if (e.target.closest('.filter-btn')) {
                const filter = e.target.closest('.filter-btn').dataset.filter;
                updateActiveButton(filter);
                filterData(filter);
            }
        });
        
        downloadBtn.addEventListener('click', downloadExcel);
        resetBtn.addEventListener('click', resetApplication);

    </script>
</body>
</html>
