# -*- coding: utf-8 -*-
"""Thesis Analyzer with Streamlit and AI

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1VSPuxIbfQkbbgrGg5vr4i5HsX_ejyfdm
"""

import streamlit as st
import pandas as pd
import requests
import io
import time

# --------------------------------------------------------------------------
# ุชุงุจุน ุจุฑุง ุงุฑุณุงู ุฏุฑุฎูุงุณุช ุจู API ู ุฏุฑุงูุช ุชุญูู
# --------------------------------------------------------------------------
def analyze_thesis_with_avvalai(title, abstract, api_key):
    """
    ุงู ุชุงุจุน ุนููุงู ู ฺฺฉุฏู ุฑุง ุจู ููุฑุงู ฺฉ ูพุฑุงููพุช ุณุงุฎุชุงุฑุงูุชู ุจู API ุงุฑุณุงู ูโฺฉูุฏ
    ู ุชุญูู ูุฏู ููุด ูุตููุน ุฑุง ุจุงุฒ ูโฺฏุฑุฏุงูุฏ.
    """
    # URL ุงูุฏูพููุช ูุฏูโูุง ฺุช ุฏุฑ avval.ai
    api_url = "https://api.avalapis.ir/v1"

    # ูุฏุฑูุง ูุงุฒู ุจุฑุง ุงุญุฑุงุฒ ููุช
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }

    # ูพุฑุงููพุช (ุฏุณุชูุฑ) ุฏูู ุจุฑุง ูุฏู ููุด ูุตููุน
    # ุงู ุจุฎุด ูููโุชุฑู ูุณูุช ุงุณุช ู ุจู ูุฏู ูโฺฏูุฏ ุฏููุงู ฺู ฺฉุงุฑ ุงูุฌุงู ุฏูุฏ.
    prompt = f"""
    **ุฏุณุชูุฑุงูุนูู ุจุฑุง ูุฏู ููุด ูุตููุน:**
    ุดูุง ฺฉ ุชุญููฺฏุฑ ูุชุฎุตุต ุฏุฑ ุฒููู ุชุฌุงุฑโุณุงุฒ ุชุญููุงุช ุฏุงุฑู ู ุจูุชฺฉููููฺ ูุณุชุฏ. ูุทูุงู ุนููุงู ู ฺฺฉุฏู ูพุงุงูโูุงูู ุฒุฑ ุฑุง ุจุง ุฏูุช ุชุญูู ฺฉุฑุฏู ู ุจู ุณู ุณูุงู ุฒุฑ ุจู ุตูุฑุช ูุฌุฒุงุ ูุงุถุญ ู ุดูุงุฑูโฺฏุฐุงุฑ ุดุฏู ูพุงุณุฎ ุฏูุฏ. ุจุฑุง ูุฑ ุจุฎุด ฺฉ ููุฑู ุงุฒ 1 ุชุง 10 ูุฒ ุงุฎุชุตุงุต ุฏูุฏ.

    **ุนููุงู ูพุงุงูโูุงูู:** "{title}"
    **ฺฺฉุฏู ูพุงุงูโูุงูู:** "{abstract}"

    ---

    **1. ูพุชุงูุณู ุชุฌุงุฑโุณุงุฒ (Commercialization Potential):**
    ุขุง ุงู ุชุญูู ูโุชูุงูุฏ ุจู ฺฉ ูุญุตูู ููุง (ุฏุงุฑูุ ฺฉุช ุชุดุฎุตุ ูุฑูููุงุณูู ุฌุฏุฏ) ุง ฺฉ ุณุฑูุณ ูุงุจู ูุฑูุด ุชุจุฏู ุดูุฏุ ุจุงุฒุงุฑ ูุฏู ุขู ฺุณุชุ ููุงูุน ุงุตู ุจุฑุง ูุฑูุฏ ุจู ุจุงุฒุงุฑ ฺฉุฏุงููุฏุ (ููุฑู ุงุฒ 1 ุชุง 10)

    **2. ุณุทุญ ููุขูุฑ (Innovation Level):**
    ุขุง ุงุฏู ูุทุฑุญ ุดุฏู ุฏุฑ ุงู ุชุญูู ุฌุฏุฏ ู ุฎูุงูุงูู ุงุณุชุ ฺู ุดฺฉุงู ุงุฒ ุฏุงูุด ุฑุง ูพุฑ ูโฺฉูุฏุ ุฏุฑ ููุงุณู ุจุง ุฑูุดโูุง ู ุฏุฑูุงูโูุง ููุฌูุฏ ฺูุฏุฑ ููุขูุฑุงูู ูุญุณูุจ ูโุดูุฏุ (ููุฑู ุงุฒ 1 ุชุง 10)

    **3. ูพุชุงูุณู ุงุฑุฒุดโุขูุฑู (Value Creation Potential):**
    ุงู ุชุญูู ฺู ุงุฑุฒุด ุจุฑุง ุจูุงุฑุงูุ ุฌุงูุนู ุนูู ุง ุตูุนุช ุฏุงุฑูุณุงุฒ ุงุฌุงุฏ ูโฺฉูุฏุ ุขุง ูโุชูุงูุฏ ุจู ุทูุฑ ุจุงูููู ูุฒููโูุง ุฏุฑูุงู ุฑุง ฺฉุงูุด ุฏูุฏุ ฺฉูุช ุฒูุฏฺฏ ุจูุงุฑุงู ุฑุง ุจูุจูุฏ ุจุฎุดุฏ ุง ูุฑุขูุฏูุง ุฏุงุฑูุณุงุฒ ุฑุง ุจูููโุชุฑ ฺฉูุฏุ (ููุฑู ุงุฒ 1 ุชุง 10)
    """

    # ุจุฏูู ุฏุฑุฎูุงุณุช (Payload)
    data = {
        "model": "avvalai-experimental",  # ูุงู ูุฏู ุฑุง ุจุฑ ุงุณุงุณ ูุณุชูุฏุงุช avval.ai ุงูุชุฎุงุจ ฺฉูุฏ
        "messages": [
            {
                "role": "user",
                "content": prompt
            }
        ]
    }

    # ุชูุงุด ุจุฑุง ุงุฑุณุงู ุฏุฑุฎูุงุณุช ุจุง ูุฏุฑุช ุฎุทุง
    max_retries = 3
    for attempt in range(max_retries):
        try:
            response = requests.post(api_url, headers=headers, json=data, timeout=60)
            response.raise_for_status()  # ุจุฑุฑุณ ุฎุทุงูุง HTTP ูุงููุฏ 4xx ุง 5xx
            result = response.json()
            analysis_text = result['choices'][0]['message']['content']
            return analysis_text.strip()
        except requests.exceptions.RequestException as e:
            if attempt < max_retries - 1:
                time.sleep(2) # Wait for 2 seconds before retrying
                continue
            else:
                st.error(f"ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง API ูพุณ ุงุฒ {max_retries} ุชูุงุด: {e}")
                return f"ุฎุทุง ุฏุฑ ุชุญูู: {e}"
        except (KeyError, IndexError):
            st.error(f"ูพุงุณุฎ ุฏุฑุงูุช ุดุฏู ุงุฒ API ูุฑูุช ููุฑุฏ ุงูุชุธุงุฑ ุฑุง ูุฏุงุฑุฏ. ูพุงุณุฎ: {response.text}")
            return "ุฎุทุง: ูุฑูุช ูพุงุณุฎ API ูุงูุนุชุจุฑ ุงุณุช."
    return "ุฎุทุง: ุชุญูู ูพุณ ุงุฒ ฺูุฏู ุชูุงุด ูุงูููู ุจูุฏ."


# --------------------------------------------------------------------------
# ุฑุงุจุท ฺฉุงุฑุจุฑ Streamlit
# --------------------------------------------------------------------------
st.set_page_config(layout="wide", page_title="ุชุญููฺฏุฑ ูพุงุงูโูุงูู ุฏุงุฑูุณุงุฒ")

# ุงุณุชุงู ุณูุงุฑุด ุจุฑุง ุธุงูุฑ ุจูุชุฑ
st.markdown("""
<style>
    .stButton>button {
        background-color: #4CAF50;
        color: white;
        border-radius: 12px;
        padding: 10px 24px;
    }
    .stDownloadButton>button {
        background-color: #008CBA;
        color: white;
        border-radius: 12px;
        padding: 10px 24px;
    }
</style>
""", unsafe_allow_html=True)


st.title("๐ฌ ุชุญููฺฏุฑ ููุดููุฏ ูพุงุงูโูุงููโูุง ุฏุงุฑูุณุงุฒ")
st.markdown("ุงู ุงุจุฒุงุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ ููุด ูุตููุน `avval.ai`ุ ูพุชุงูุณู **ุชุฌุงุฑโุณุงุฒุ ููุขูุฑ ู ุงุฑุฒุดโุขูุฑู** ูพุงุงูโูุงููโูุง ุฑุง ุชุญูู ูโฺฉูุฏ.")

# ุฏุฑุงูุช ฺฉูุฏ API ุฏุฑ ููุงุฑ ฺฉูุงุฑ
st.sidebar.header("ุชูุธูุงุช")
api_key = st.sidebar.text_input("๐ ฺฉูุฏ API ุฎูุฏ ุฑุง ุงุฒ ุณุงุช avval.ai ูุงุฑุฏ ฺฉูุฏ:", type="password", help="ฺฉูุฏ API ุดูุง ุจุฑุง ุงููุชุ ุฐุฎุฑู ูุฎูุงูุฏ ุดุฏ.")

st.sidebar.markdown("---")
st.sidebar.info("ูุงู ุงฺฉุณู ูุฑูุฏ ุจุงุฏ ุดุงูู ุฏู ุณุชูู ุจุง ูุงูโูุง ุฏูู `Title` ู `Abstract` ุจุงุดุฏ.")

# ุจุฎุด ุจุงุฑฺฏุฐุงุฑ ูุงู
uploaded_file = st.file_uploader("๐ ูุงู ุงฺฉุณู ุฎูุฏ ุฑุง ุงูุฌุง ุจุงุฑฺฏุฐุงุฑ ฺฉูุฏ:", type=["xlsx"])

if uploaded_file is not None:
    try:
        df = pd.read_excel(uploaded_file)
        st.subheader("ูพุดโููุงุด ุฏุงุฏูโูุง ูุฑูุฏ:")
        st.dataframe(df.head())

        # ุจุฑุฑุณ ูุฌูุฏ ุณุชููโูุง ุงูุฒุงู
        if 'Title' not in df.columns or 'Abstract' not in df.columns:
            st.error("ุฎุทุง: ูุงู ุงฺฉุณู ุจุงุฏ ุญุชูุงู ุดุงูู ุณุชููโูุง 'Title' ู 'Abstract' ุจุงุดุฏ.")
        elif st.button("๐ ุดุฑูุน ุชุญูู"):
            if not api_key:
                st.warning("ูุทูุงู ฺฉูุฏ API ุฎูุฏ ุฑุง ุฏุฑ ููุงุฑ ฺฉูุงุฑ ูุงุฑุฏ ฺฉูุฏ.")
            else:
                analyses = []
                total_rows = len(df)
                progress_bar = st.progress(0)
                status_text = st.empty()

                # ุญููู ุจุฑุง ุชุญูู ุชฺฉ ุชฺฉ ุฑุฏูโูุง
                for index, row in df.iterrows():
                    title = str(row.get('Title', ''))
                    abstract = str(row.get('Abstract', ''))

                    # ุงุทููุงู ุงุฒ ุงูฺฉู ุฏุงุฏูโูุง ุฎุงู ูุณุชูุฏ
                    if title and abstract:
                        analysis_result = analyze_thesis_with_avvalai(title, abstract, api_key)
                        analyses.append(analysis_result)
                    else:
                        analyses.append("ุฎุทุง: ุนููุงู ุง ฺฺฉุฏู ุฏุฑ ุงู ุฑุฏู ุฎุงู ุงุณุช.")

                    # ุจูโุฑูุฒุฑุณุงู ููุงุฑ ูพุดุฑูุช
                    progress_value = (index + 1) / total_rows
                    progress_bar.progress(progress_value)
                    status_text.text(f"ุฏุฑ ุญุงู ุชุญูู ุฑุฏู {index + 1} ุงุฒ {total_rows}...")

                status_text.success("โ ุชุญูู ููู ููุงุฑุฏ ุจุง ููููุช ุงูุฌุงู ุดุฏ!")

                # ุงุถุงูู ฺฉุฑุฏู ุณุชูู ุฌุฏุฏ ุจู ุฏุชุงูุฑู
                df_results = df.copy()
                df_results['AI_Analysis'] = analyses

                st.subheader("ูุชุงุฌ ุชุญูู:")
                st.dataframe(df_results)

                # ุขูุงุฏูโุณุงุฒ ูุงู ุงฺฉุณู ุจุฑุง ุฏุงูููุฏ
                output = io.BytesIO()
                with pd.ExcelWriter(output, engine='openpyxl') as writer:
                    df_results.to_excel(writer, index=False, sheet_name='Analysis_Results')

                excel_data = output.getvalue()

                st.download_button(
                    label="๐ฅ ุฏุงูููุฏ ูุชุงุฌ ุฏุฑ ูุงูุจ ูุงู ุงฺฉุณู",
                    data=excel_data,
                    file_name="thesis_analysis_results.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )

    except Exception as e:
        st.error(f"ฺฉ ุฎุทุง ุฏุฑ ูพุฑุฏุงุฒุด ูุงู ุฑุฎ ุฏุงุฏ: {e}")
