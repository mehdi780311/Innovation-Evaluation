import streamlit as st
import pandas as pd
import google.generativeai as genai
import io
from time import sleep

# --- Page Configuration ---
# ุชูุธูุงุช ุงููู ุตูุญู ุดุงูู ุนููุงูุ ุขฺฉูู ู ุทุฑุญโุจูุฏ
st.set_page_config(
    page_title="ุชุญููฺฏุฑ ููุขูุฑ ูพุงุงูโูุงูู",
    page_icon="๐ก",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- Functions ---

def create_prompt(title, abstract):
    """
    ุงู ุชุงุจุน ฺฉ ุฏุณุชูุฑ (prompt) ุฏูู ุจุฑุง ูุฏู ููุด ูุตููุน ุจุฑ ุงุณุงุณ ุฌุฏูู ุงุฑุฒุงุจ ููุขูุฑ ุงุฌุงุฏ ูโฺฉูุฏ.
    """
    return f"""
        ุดูุง ฺฉ ูุชุฎุตุต ุงุฑุฒุงุจ ููุขูุฑ ู ุงูุชูุงู ููุงูุฑ ูุณุชุฏ.
        ูุธูู ุดูุง ุชุญูู ุนููุงู ู ฺฺฉุฏู ูพุงุงูโูุงูู ุฒุฑ ุจุฑ ุงุณุงุณ **"ุฌุฏูู ุงุฑุฒุงุจ ุงุซุจุงุช ููููู ุจุฑุง ุฑุชุจูโุจูุฏ ููุขูุฑ"** ุงุณุช.
        ุจุฑุง ูุฑ ฺฉ ุงุฒ ต ุดุงุฎุต ุฒุฑุ ฺฉ ุงูุชุงุฒ ุจุฑ ุงุณุงุณ ุชูุถุญุงุช ุฏุงุฏู ุดุฏู ุงุฎุชุตุงุต ุฏูุฏ ู ุฏุฑ ููุงุช ููุฑู ฺฉู ู ูพุชุงูุณู ููุขูุฑ ุฑุง ูุดุฎุต ฺฉูุฏ.

        **ุดุงุฎุตโูุง ู ูุญูู ุงูุชุงุฒุฏู:**

        1.  **ุญูุฒู ุนูู ูพุงุงูโูุงูู (ุงูุชุงุฒ ฐ ุชุง ณ):** ุขุง ุฏุฑ ุญูุฒูโูุง ุงุณุช ฺฉู ุจุดุชุฑู ุงุฑุฌุญุช ุฑุง ุฏุงุฑูุฏุ (ูุงููุฏ: ุฏุงุฑูุณุงุฒุ ูููุฏุณ ุนููู ุฒุณุชุ ููุงุฏุ ูพุฒุดฺฉ ู...). ุงฺฏุฑ ุฏุฑ ุญูุฒูโูุง ุจุง ุงูููุช ุจุงูุง ุจูุฏ ุงูุชุงุฒ ณุ ูุชูุณุท ฒุ ฺฉู ฑ ู ูุงูุฑุชุจุท ฐ ุจุฏูุฏ.
        2.  **ุงุณุชูุงุฏู ุงุฒ ููุงูุฑ ุจุง ููุขูุฑ ุฎุงุต (ุงูุชุงุฒ ฐ ุชุง ณ):** ุขุง ฺฺฉุฏู ุจู ุชฺฉููููฺ ููุ ูุฏู ููุ ูุญุตููุ ุงูฺฏูุฑุชูุ ูุฑุขูุฏุ ุง ูุชุฏูููฺ ุฌุฏุฏ ุงุดุงุฑู ุฏุงุฑุฏุ ุงฺฏุฑ ุงุดุงุฑู ูุงุถุญ ุฏุงุดุช ุงูุชุงุฒ ณุ ุงุดุงุฑู ุถูู ฑุ ู ุฏุฑ ุบุฑ ุงู ุตูุฑุช ฐ ุจุฏูุฏ.
        3.  **ุญู ูุณุฆูู ุตูุนุช/ุงุฌุชูุงุน ูุดุฎุต (ุงูุชุงุฒ ฐ ุชุง ณ):** ุขุง ุฏุฑ ฺฺฉุฏู ุจู ฺฉ ูุงุฒ ุง ูุณุฆูู ฺฉุงุฑุจุฑุฏ ุฎุงุต ุงุดุงุฑู ุดุฏู ุงุณุชุ ุงฺฏุฑ ูุณุฆูู ฺฉุงููุงู ูุดุฎุต ู ฺฉุงุฑุจุฑุฏ ุงุณุช ุงูุชุงุฒ ณุ ุงฺฏุฑ ฺฉู ุงุณุช ฑ ู ุฏุฑ ุบุฑ ุงู ุตูุฑุช ฐ ุจุฏูุฏ.
        4.  **ูุงุจูุช ุชุฌุงุฑโุณุงุฒ (ุงูุชุงุฒ ฐ ุชุง ณ):** ุขุง ูพุงุงูโูุงูู ุจู ูุชุงุฌ ููููุณ ฺฉู ูุงุจู ุชูุณุนู ุจู ูุญุตููุ ูุฑูโุงูุฒุงุฑุ ุง ุฏุณุชฺฏุงู ุจุงุดุฏุ ุงุดุงุฑู ูโฺฉูุฏุ ุงฺฏุฑ ูพุชุงูุณู ูุณุชูู ุฏุงุฑุฏ ุงูุชุงุฒ ณุ ูพุชุงูุณู ุบุฑูุณุชูู ฑ ู ุฏุฑ ุบุฑ ุงู ุตูุฑุช ฐ ุจุฏูุฏ.
        5.  **ููฺฉุงุฑ ุจุง ุตูุนุช/ููุงุฏ ุบุฑุฏุงูุดฺฏุงู (ุงูุชุงุฒ ฐ ุง ฑ):** ุขุง ฺฺฉุฏู ูุดุงู ูโุฏูุฏ ุจุง ฺฉ ููุงุฏ ุตูุนุช ุง ุณุงุฒูุงู ููฺฉุงุฑ ุดุฏู ุงุณุชุ ุงฺฏุฑ ุจูู ฑุ ุงฺฏุฑ ูู ฐ.

        **ุชุญูู ู ุฎุฑูุฌ:**
        ูพุณ ุงุฒ ุงูุชุงุฒุฏู ุจู ูุฑ ุดุงุฎุตุ ููุฑู ููุง ุฑุง ุงุฒ ุฌูุน ุงูุชุงุฒุงุช ูุญุงุณุจู ฺฉูุฏ.
        ุณูพุณ ุจุฑ ุงุณุงุณ ููุฑู ููุงุ "ูพุชุงูุณู ููุขูุฑ" ุฑุง ุทุจููโุจูุฏ ฺฉูุฏ:
        - **ูพุชุงูุณู ุจุงูุง:** ููุฑู ธ ุชุง ฑฐ (ู ุจุงูุงุชุฑ)
        - **ูพุชุงูุณู ูุชูุณุท:** ููุฑู ต ุชุง ท
        - **ูพุชุงูุณู ุถุนู:** ููุฑู ฺฉูุชุฑ ุงุฒ ต

        ุฏุฑ ุงูุชูุง ฺฉ ุชุญูู ฺฉู ูุฎุชุตุฑ (ุญุฏุงฺฉุซุฑ ฒ ุฌููู) ุจุฑุง ุชูุฌู ุงูุชุงุฒุงุช ุงุฑุงุฆู ุฏูุฏ.

        ุฎุฑูุฌ ุฑุง **ุฏููุง** ุจุง ูุฑูุช ุฒุฑ ู ููุท ุจู ุฒุจุงู ูุงุฑุณ ุงุฑุงุฆู ุฏูุฏ:

        ุญูุฒู ุนูู: [ุงูุชุงุฒ]/2
        ููุงูุฑ ุฎุงุต: [ุงูุชุงุฒ]/3
        ุญู ูุณุฆูู: [ุงูุชุงุฒ]/2
        ุชุฌุงุฑโุณุงุฒ: [ุงูุชุงุฒ]/2
        ููฺฉุงุฑ: [ุงูุชุงุฒ]/1
        ููุฑู ููุง: [ุฌูุน ุงูุชุงุฒุงุช]
        ูพุชุงูุณู ููุขูุฑ: [ุถุนู/ูุชูุณุท/ุจุงูุง]
        ุชุญูู ฺฉู: [ุฎูุงุตู ุชุญูู ุดูุง ุฏุฑ ุงูุฌุง]

        ---
        **ุนููุงู ูพุงุงูโูุงูู:** {title}

        **ฺฺฉุฏู ูพุงุงูโูุงูู:** {abstract}
        ---
    """

def parse_response(text):
    """
    ุงู ุชุงุจุน ูพุงุณุฎ ุณุงุฎุชุงุฑุงูุชู ูุฏู ููุด ูุตููุน ุฑุง ุจุฑ ุงุณุงุณ ูุนุงุฑูุง ุฌุฏุฏ ุชุฌุฒู ูโฺฉูุฏ.
    """
    data = {
        "ุญูุฒู ุนูู": "N/A",
        "ููุงูุฑ ุฎุงุต": "N/A",
        "ุญู ูุณุฆูู": "N/A",
        "ุชุฌุงุฑโุณุงุฒ": "N/A",
        "ููฺฉุงุฑ": "N/A",
        "ููุฑู ููุง": "N/A",
        "ูพุชุงูุณู ููุขูุฑ": "N/A",
        "ุชุญูู ฺฉู": "ุฎุทุง ุฏุฑ ูพุฑุฏุงุฒุด ูพุงุณุฎ ูุฏู."
    }
    try:
        lines = text.strip().split('\n')
        for line in lines:
            if "ุญูุฒู ุนูู:" in line:
                data["ุญูุฒู ุนูู"] = line.split(':')[1].strip().split('/')[0]
            elif "ููุงูุฑ ุฎุงุต:" in line:
                data["ููุงูุฑ ุฎุงุต"] = line.split(':')[1].strip().split('/')[0]
            elif "ุญู ูุณุฆูู:" in line:
                data["ุญู ูุณุฆูู"] = line.split(':')[1].strip().split('/')[0]
            elif "ุชุฌุงุฑโุณุงุฒ:" in line:
                data["ุชุฌุงุฑโุณุงุฒ"] = line.split(':')[1].strip().split('/')[0]
            elif "ููฺฉุงุฑ:" in line:
                data["ููฺฉุงุฑ"] = line.split(':')[1].strip().split('/')[0]
            elif "ููุฑู ููุง:" in line:
                data["ููุฑู ููุง"] = line.split(':')[1].strip()
            elif "ูพุชุงูุณู ููุขูุฑ:" in line:
                data["ูพุชุงูุณู ููุขูุฑ"] = line.split(':')[1].strip()
            elif "ุชุญูู ฺฉู:" in line:
                data["ุชุญูู ฺฉู"] = line.split(':', 1)[1].strip()
    except Exception:
        # ุฏุฑ ุตูุฑุช ุจุฑูุฒ ุฎุทุง ุฏุฑ ุชุฌุฒูุ ุงุฒ ูพุงู ูพุดโูุฑุถ ุงุณุชูุงุฏู ูโุดูุฏ.
        pass
    return data

def to_excel(df):
    """
    ฺฉ DataFrame ุฑุง ุจู ูุงู ุงฺฉุณู ุฏุฑ ุญุงูุธู (in-memory) ุชุจุฏู ูโฺฉูุฏ.
    """
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='ุชุญูู_ููุขูุฑ')
        # ุชูุธู ุฎูุฏฺฉุงุฑ ุนุฑุถ ุณุชููโูุง ุจุฑุง ุฎูุงูุง ุจูุชุฑ
        for column in df:
            column_length = max(df[column].astype(str).map(len).max(), len(column)) + 2
            col_idx = df.columns.get_loc(column)
            writer.sheets['ุชุญูู_ููุขูุฑ'].set_column(col_idx, col_idx, column_length)
    processed_data = output.getvalue()
    return processed_data


# --- Streamlit App UI ---

st.title("๐ก ุชุญููฺฏุฑ ููุดููุฏ ูพุชุงูุณู ููุขูุฑ ูพุงุงูโูุงููโูุง")
st.markdown("ุงู ุงุจุฒุงุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ ููุด ูุตููุน Gemini ู ุจุฑ ุงุณุงุณ **ูุฏู ุฑุชุจูโุจูุฏ ููุขูุฑ**ุ ูพุชุงูุณู ูพุงุงูโูุงููโูุง ุฑุง ุชุญูู ูโฺฉูุฏ.")

# ููุงุฑ ฺฉูุงุฑ ุจุฑุง ุฏุฑุงูุช ูุฑูุฏโูุง
st.sidebar.header("ุชูุธูุงุช")

# 1. ูุฑูุฏ ฺฉูุฏ API
api_key = st.sidebar.text_input("๐ ฺฉูุฏ API ฺฏูฺฏู Gemini ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ:", type="password", help="ฺฉูุฏ API ุดูุง ูุญุฑูุงูู ุจุงู ูโูุงูุฏ ู ููุท ุจุฑุง ุงู ุฌูุณู ุงุณุชูุงุฏู ูโุดูุฏ.")

if not api_key:
    st.warning("ูุทูุงู ุจุฑุง ุดุฑูุน ุชุญููุ ฺฉูุฏ API ฺฏูฺฏู Gemini ุฎูุฏ ุฑุง ุฏุฑ ููุงุฑ ฺฉูุงุฑ ูุงุฑุฏ ฺฉูุฏ.")
    st.stop()

try:
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel('gemini-1.5-flash-latest')
except Exception as e:
    st.error(f"โ ุฎุทุง ุฏุฑ ุชูุธู ฺฉูุฏ API: ูุทูุงู ุงุฒ ูุนุชุจุฑ ุจูุฏู ฺฉูุฏ ุฎูุฏ ุงุทููุงู ุญุงุตู ฺฉูุฏ.")
    st.stop()

# 2. ุจุงุฑฺฏุฐุงุฑ ูุงู
uploaded_file = st.file_uploader("๐ ูุงู ุงฺฉุณู ุญุงู ุนูุงูู ู ฺฺฉุฏูโูุง ุฑุง ุจุงุฑฺฏุฐุงุฑ ฺฉูุฏ", type=["xlsx"])

if uploaded_file is not None:
    try:
        df = pd.read_excel(uploaded_file)
        st.success("โ ูุงู ุจุง ููููุช ุจุงุฑฺฏุฐุงุฑ ุดุฏ. ูุทูุง ุณุชููโูุง ุฑุง ูุดุฎุต ฺฉูุฏ.")
        st.dataframe(df.head())

        st.sidebar.header("ุงูุชุฎุงุจ ุณุชููโูุง")
        columns = df.columns.tolist()

        # 3. ุงูุชุฎุงุจ ุณุชููโูุง
        title_col = st.sidebar.selectbox("ุณุชูู ุญุงู **ุนููุงู** ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ:", columns, index=0)
        abstract_col = st.sidebar.selectbox("ุณุชูู ุญุงู **ฺฺฉุฏู** ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ:", columns, index=1 if len(columns) > 1 else 0)

        if st.button("๐ ุดุฑูุน ุชุญูู", type="primary"):
            if title_col == abstract_col:
                st.error("ุณุชูู ุนููุงู ู ฺฺฉุฏู ููโุชูุงููุฏ ฺฉุณุงู ุจุงุดูุฏ.")
            else:
                with st.spinner("ุฏุฑ ุญุงู ุชุญูู... ุงู ูุฑุขูุฏ ููฺฉู ุงุณุช ุจุณุชู ุจู ุชุนุฏุงุฏ ุฑุฏูโูุง ุฒูุงูโุจุฑ ุจุงุดุฏ."):
                    progress_bar = st.progress(0, text="ุดุฑูุน ูุฑุขูุฏ ุชุญูู...")
                    total_rows = len(df)
                    results = []

                    for i, row in df.iterrows():
                        title = str(row.get(title_col, ''))
                        abstract = str(row.get(abstract_col, ''))

                        if not title or not abstract:
                            results.append({
                                "ุญูุฒู ุนูู": "N/A", "ููุงูุฑ ุฎุงุต": "N/A", "ุญู ูุณุฆูู": "N/A",
                                "ุชุฌุงุฑโุณุงุฒ": "N/A", "ููฺฉุงุฑ": "N/A", "ููุฑู ููุง": "N/A",
                                "ูพุชุงูุณู ููุขูุฑ": "N/A", "ุชุญูู ฺฉู": "ุนููุงู ุง ฺฺฉุฏู ููุฌูุฏ ูุณุช."
                            })
                        else:
                            prompt = create_prompt(title, abstract)
                            try:
                                response = model.generate_content(prompt)
                                parsed_data = parse_response(response.text)
                                results.append(parsed_data)
                            except Exception as e:
                                st.error(f"ุฎุทุง ุฏุฑ ุฑุฏู {i+1}: {e}")
                                results.append({
                                    "ุญูุฒู ุนูู": "ุฎุทุง", "ููุงูุฑ ุฎุงุต": "ุฎุทุง", "ุญู ูุณุฆูู": "ุฎุทุง",
                                    "ุชุฌุงุฑโุณุงุฒ": "ุฎุทุง", "ููฺฉุงุฑ": "ุฎุทุง", "ููุฑู ููุง": "ุฎุทุง",
                                    "ูพุชุงูุณู ููุขูุฑ": "ุฎุทุง", "ุชุญูู ฺฉู": str(e)
                                })
                        
                        # ฺฉ ุชุฃุฎุฑ ฺฉูุชุงู ุจุฑุง ุฌููฺฏุฑ ุงุฒ ุฑุณุฏู ุจู ูุญุฏูุฏุชโูุง API
                        sleep(1)
                        progress_bar.progress((i + 1) / total_rows, text=f"ุฏุฑ ุญุงู ูพุฑุฏุงุฒุด ุฑุฏู {i+1} ุงุฒ {total_rows}")
                    
                st.success("๐ ุชุญูู ุจุง ููููุช ุงูุฌุงู ุดุฏ!")

                # ุงุฌุงุฏ DataFrame ุงุฒ ูุชุงุฌ ู ุงูุญุงู ุขู ุจู DataFrame ุงุตู
                results_df = pd.DataFrame(results)
                
                # ุชุบุฑ ูุงู ุณุชููโูุง ุจุฑุง ูุถูุญ ุจุดุชุฑ ุฏุฑ ูุงู ุงฺฉุณู ุฎุฑูุฌ
                results_df.rename(columns={
                    "ุญูุฒู ุนูู": "ุงูุชุงุฒ ุญูุฒู ุนูู",
                    "ููุงูุฑ ุฎุงุต": "ุงูุชุงุฒ ููุงูุฑ ุฎุงุต",
                    "ุญู ูุณุฆูู": "ุงูุชุงุฒ ุญู ูุณุฆูู",
                    "ุชุฌุงุฑโุณุงุฒ": "ุงูุชุงุฒ ุชุฌุงุฑโุณุงุฒ",
                    "ููฺฉุงุฑ": "ุงูุชุงุฒ ููฺฉุงุฑ",
                }, inplace=True)
                
                final_df = pd.concat([df, results_df], axis=1)

                st.dataframe(final_df)

                # 4. ุฏฺฉูู ุฏุงูููุฏ
                excel_data = to_excel(final_df)
                st.download_button(
                    label="๐ฅ ุฏุงูููุฏ ูุงู ุงฺฉุณู ูุชุงุฌ",
                    data=excel_data,
                    file_name="ุชุญูู_ููุขูุฑ_ูพุงุงูโูุงููโูุง.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
    except Exception as e:
        st.error(f"ุฎุทุง ุฏุฑ ุฎูุงูุฏู ูุงู ุงฺฉุณู: {e}")
