import streamlit as st
import pandas as pd
import google.generativeai as genai
import google.api_core.exceptions  # <-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù„Ø§Ø²Ù… Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª API
import io
from time import sleep

# --- Page Configuration ---
st.set_page_config(
    page_title="ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ù†ÙˆØ¢ÙˆØ±ÛŒ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡",
    page_icon="ğŸ’¡",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- Functions ---

def create_prompt(title, abstract):
    """
    Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ ÛŒÚ© Ø¯Ø³ØªÙˆØ± (prompt) Ø¯Ù‚ÛŒÙ‚ Ø¨Ø±Ø§ÛŒ Ù…Ø¯Ù„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¬Ø¯ÙˆÙ„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù†ÙˆØ¢ÙˆØ±ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    """
    return f"""
        Ø´Ù…Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ù†ÙˆØ¢ÙˆØ±ÛŒ Ùˆ Ø§Ù†ØªÙ‚Ø§Ù„ ÙÙ†Ø§ÙˆØ±ÛŒ Ù‡Ø³ØªÛŒØ¯.
        ÙˆØ¸ÛŒÙÙ‡ Ø´Ù…Ø§ ØªØ­Ù„ÛŒÙ„ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ú†Ú©ÛŒØ¯Ù‡ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡ Ø²ÛŒØ± Ø¨Ø± Ø§Ø³Ø§Ø³ **"Ø¬Ø¯ÙˆÙ„ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø«Ø¨Ø§Øª Ù…ÙÙ‡ÙˆÙ… Ø¨Ø±Ø§ÛŒ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù†ÙˆØ¢ÙˆØ±ÛŒ"** Ø§Ø³Øª.
        Ø¨Ø±Ø§ÛŒ Ù‡Ø± ÛŒÚ© Ø§Ø² Ûµ Ø´Ø§Ø®Øµ Ø²ÛŒØ±ØŒ ÛŒÚ© Ø§Ù…ØªÛŒØ§Ø² Ø¨Ø± Ø§Ø³Ø§Ø³ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡ Ø§Ø®ØªØµØ§Øµ Ø¯Ù‡ÛŒØ¯ Ùˆ Ø¯Ø± Ù†Ù‡Ø§ÛŒØª Ù†Ù…Ø±Ù‡ Ú©Ù„ Ùˆ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù†ÙˆØ¢ÙˆØ±ÛŒ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.

        **Ø´Ø§Ø®Øµâ€ŒÙ‡Ø§ Ùˆ Ù†Ø­ÙˆÙ‡ Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ:**

        1.  **Ø­ÙˆØ²Ù‡ Ø¹Ù„Ù…ÛŒ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡ (Ø§Ù…ØªÛŒØ§Ø² Û° ØªØ§ Û³):** Ø¢ÛŒØ§ Ø¯Ø± Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ø§Ø³Øª Ú©Ù‡ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§Ø±Ø¬Ø­ÛŒØª Ø±Ø§ Ø¯Ø§Ø±Ù†Ø¯ØŸ (Ù…Ø§Ù†Ù†Ø¯: Ø¯Ø§Ø±ÙˆØ³Ø§Ø²ÛŒØŒ Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ø¹Ù„ÙˆÙ… Ø²ÛŒØ³ØªÛŒØŒ Ù…ÙˆØ§Ø¯ØŒ Ù¾Ø²Ø´Ú©ÛŒ Ùˆ...). Ø§Ú¯Ø± Ø¯Ø± Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§ Ø¨ÙˆØ¯ Ø§Ù…ØªÛŒØ§Ø² Û³ØŒ Ù…ØªÙˆØ³Ø· Û²ØŒ Ú©Ù… Û± Ùˆ Ù†Ø§Ù…Ø±ØªØ¨Ø· Û° Ø¨Ø¯Ù‡ÛŒØ¯.
        2.  **Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ÙÙ†Ø§ÙˆØ±ÛŒ Ø¨Ø§ Ù†ÙˆØ¢ÙˆØ±ÛŒ Ø®Ø§Øµ (Ø§Ù…ØªÛŒØ§Ø² Û° ØªØ§ Û³):** Ø¢ÛŒØ§ Ú†Ú©ÛŒØ¯Ù‡ Ø¨Ù‡ ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒ Ù†ÙˆØŒ Ù…Ø¯Ù„ ÙÙ†ÛŒØŒ Ù…Ø­ØµÙˆÙ„ØŒ Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ…ØŒ ÙØ±Ø¢ÛŒÙ†Ø¯ØŒ ÛŒØ§ Ù…ØªØ¯ÙˆÙ„ÙˆÚ˜ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø´Ø§Ø±Ù‡ Ø¯Ø§Ø±Ø¯ØŸ Ø§Ú¯Ø± Ø§Ø´Ø§Ø±Ù‡ ÙˆØ§Ø¶Ø­ÛŒ Ø¯Ø§Ø´Øª Ø§Ù…ØªÛŒØ§Ø² Û³ØŒ Ø§Ø´Ø§Ø±Ù‡ Ø¶Ù…Ù†ÛŒ Û±ØŒ Ùˆ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Û° Ø¨Ø¯Ù‡ÛŒØ¯.
        3.  **Ø­Ù„ Ù…Ø³Ø¦Ù„Ù‡ ØµÙ†Ø¹ØªÛŒ/Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ Ù…Ø´Ø®Øµ (Ø§Ù…ØªÛŒØ§Ø² Û° ØªØ§ Û³):** Ø¢ÛŒØ§ Ø¯Ø± Ú†Ú©ÛŒØ¯Ù‡ Ø¨Ù‡ ÛŒÚ© Ù†ÛŒØ§Ø² ÛŒØ§ Ù…Ø³Ø¦Ù„Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ø®Ø§Øµ Ø§Ø´Ø§Ø±Ù‡ Ø´Ø¯Ù‡ Ø§Ø³ØªØŸ Ø§Ú¯Ø± Ù…Ø³Ø¦Ù„Ù‡ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…Ø´Ø®Øµ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ Ø§Ø³Øª Ø§Ù…ØªÛŒØ§Ø² Û³ØŒ Ø§Ú¯Ø± Ú©Ù„ÛŒ Ø§Ø³Øª Û± Ùˆ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Û° Ø¨Ø¯Ù‡ÛŒØ¯.
        4.  **Ù‚Ø§Ø¨Ù„ÛŒØª ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ (Ø§Ù…ØªÛŒØ§Ø² Û° ØªØ§ Û³):** Ø¢ÛŒØ§ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡ Ø¨Ù‡ Ù†ØªØ§ÛŒØ¬ Ù…Ù„Ù…ÙˆØ³ÛŒ Ú©Ù‡ Ù‚Ø§Ø¨Ù„ ØªÙˆØ³Ø¹Ù‡ Ø¨Ù‡ Ù…Ø­ØµÙˆÙ„ØŒ Ù†Ø±Ù…â€ŒØ§ÙØ²Ø§Ø±ØŒ ÛŒØ§ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø´Ø§Ø±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ØŸ Ø§Ú¯Ø± Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø§Ø±Ø¯ Ø§Ù…ØªÛŒØ§Ø² Û³ØŒ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ ØºÛŒØ±Ù…Ø³ØªÙ‚ÛŒÙ… Û± Ùˆ Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±Øª Û° Ø¨Ø¯Ù‡ÛŒØ¯.
        5.  **Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø¨Ø§ ØµÙ†Ø¹Øª/Ù†Ù‡Ø§Ø¯ ØºÛŒØ±Ø¯Ø§Ù†Ø´Ú¯Ø§Ù‡ÛŒ (Ø§Ù…ØªÛŒØ§Ø² Û° ÛŒØ§ Û±):** Ø¢ÛŒØ§ Ú†Ú©ÛŒØ¯Ù‡ Ù†Ø´Ø§Ù† Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ Ø¨Ø§ ÛŒÚ© Ù†Ù‡Ø§Ø¯ ØµÙ†Ø¹ØªÛŒ ÛŒØ§ Ø³Ø§Ø²Ù…Ø§Ù†ÛŒ Ù‡Ù…Ú©Ø§Ø±ÛŒ Ø´Ø¯Ù‡ Ø§Ø³ØªØŸ Ø§Ú¯Ø± Ø¨Ù„Ù‡ Û±ØŒ Ø§Ú¯Ø± Ù†Ù‡ Û°.

        **ØªØ­Ù„ÛŒÙ„ Ùˆ Ø®Ø±ÙˆØ¬ÛŒ:**
        Ù¾Ø³ Ø§Ø² Ø§Ù…ØªÛŒØ§Ø²Ø¯Ù‡ÛŒ Ø¨Ù‡ Ù‡Ø± Ø´Ø§Ø®ØµØŒ Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ø§Ø² Ø¬Ù…Ø¹ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©Ù†ÛŒØ¯.
        Ø³Ù¾Ø³ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒØŒ "Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù†ÙˆØ¢ÙˆØ±ÛŒ" Ø±Ø§ Ø·Ø¨Ù‚Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ù†ÛŒØ¯:
        - **Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¨Ø§Ù„Ø§:** Ù†Ù…Ø±Ù‡ Û¸ ØªØ§ Û±Û° (Ùˆ Ø¨Ø§Ù„Ø§ØªØ±)
        - **Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù…ØªÙˆØ³Ø·:** Ù†Ù…Ø±Ù‡ Ûµ ØªØ§ Û·
        - **Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ø¶Ø¹ÛŒÙ:** Ù†Ù…Ø±Ù‡ Ú©Ù…ØªØ± Ø§Ø² Ûµ

        Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ ÛŒÚ© ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ Ù…Ø®ØªØµØ± (Ø­Ø¯Ø§Ú©Ø«Ø± Û² Ø¬Ù…Ù„Ù‡) Ø¨Ø±Ø§ÛŒ ØªÙˆØ¬ÛŒÙ‡ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯.

        Ø®Ø±ÙˆØ¬ÛŒ Ø±Ø§ **Ø¯Ù‚ÛŒÙ‚Ø§** Ø¨Ø§ ÙØ±Ù…Øª Ø²ÛŒØ± Ùˆ ÙÙ‚Ø· Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯:

        Ø­ÙˆØ²Ù‡ Ø¹Ù„Ù…ÛŒ: [Ø§Ù…ØªÛŒØ§Ø²]/3
        ÙÙ†Ø§ÙˆØ±ÛŒ Ø®Ø§Øµ: [Ø§Ù…ØªÛŒØ§Ø²]/3
        Ø­Ù„ Ù…Ø³Ø¦Ù„Ù‡: [Ø§Ù…ØªÛŒØ§Ø²]/3
        ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ: [Ø§Ù…ØªÛŒØ§Ø²]/3
        Ù‡Ù…Ú©Ø§Ø±ÛŒ: [Ø§Ù…ØªÛŒØ§Ø²]/1
        Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ: [Ø¬Ù…Ø¹ Ø§Ù…ØªÛŒØ§Ø²Ø§Øª]
        Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù†ÙˆØ¢ÙˆØ±ÛŒ: [Ø¶Ø¹ÛŒÙ/Ù…ØªÙˆØ³Ø·/Ø¨Ø§Ù„Ø§]
        ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ: [Ø®Ù„Ø§ØµÙ‡ ØªØ­Ù„ÛŒÙ„ Ø´Ù…Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§]

        ---
        **Ø¹Ù†ÙˆØ§Ù† Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡:** {title}

        **Ú†Ú©ÛŒØ¯Ù‡ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡:** {abstract}
        ---
    """

def parse_response(text):
    """
    Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ù¾Ø§Ø³Ø® Ø³Ø§Ø®ØªØ§Ø±ÛŒØ§ÙØªÙ‡ Ù…Ø¯Ù„ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ ØªØ¬Ø²ÛŒÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    """
    data = {
        "Ø­ÙˆØ²Ù‡ Ø¹Ù„Ù…ÛŒ": "N/A",
        "ÙÙ†Ø§ÙˆØ±ÛŒ Ø®Ø§Øµ": "N/A",
        "Ø­Ù„ Ù…Ø³Ø¦Ù„Ù‡": "N/A",
        "ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ": "N/A",
        "Ù‡Ù…Ú©Ø§Ø±ÛŒ": "N/A",
        "Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ": "N/A",
        "Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù†ÙˆØ¢ÙˆØ±ÛŒ": "N/A",
        "ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ": "Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾Ø§Ø³Ø® Ù…Ø¯Ù„."
    }
    try:
        lines = text.strip().split('\n')
        for line in lines:
            if "Ø­ÙˆØ²Ù‡ Ø¹Ù„Ù…ÛŒ:" in line:
                data["Ø­ÙˆØ²Ù‡ Ø¹Ù„Ù…ÛŒ"] = line.split(':')[1].strip().split('/')[0]
            elif "ÙÙ†Ø§ÙˆØ±ÛŒ Ø®Ø§Øµ:" in line:
                data["ÙÙ†Ø§ÙˆØ±ÛŒ Ø®Ø§Øµ"] = line.split(':')[1].strip().split('/')[0]
            elif "Ø­Ù„ Ù…Ø³Ø¦Ù„Ù‡:" in line:
                data["Ø­Ù„ Ù…Ø³Ø¦Ù„Ù‡"] = line.split(':')[1].strip().split('/')[0]
            elif "ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ:" in line:
                data["ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ"] = line.split(':')[1].strip().split('/')[0]
            elif "Ù‡Ù…Ú©Ø§Ø±ÛŒ:" in line:
                data["Ù‡Ù…Ú©Ø§Ø±ÛŒ"] = line.split(':')[1].strip().split('/')[0]
            elif "Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ:" in line:
                data["Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ"] = line.split(':')[1].strip()
            elif "Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù†ÙˆØ¢ÙˆØ±ÛŒ:" in line:
                data["Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù†ÙˆØ¢ÙˆØ±ÛŒ"] = line.split(':')[1].strip()
            elif "ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ:" in line:
                data["ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ"] = line.split(':', 1)[1].strip()
    except Exception:
        pass
    return data

def to_excel(df):
    """
    ÛŒÚ© DataFrame Ø±Ø§ Ø¨Ù‡ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ (in-memory) ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    """
    output = io.BytesIO()
    with pd.ExcelWriter(output, engine='xlsxwriter') as writer:
        df.to_excel(writer, index=False, sheet_name='ØªØ­Ù„ÛŒÙ„_Ù†ÙˆØ¢ÙˆØ±ÛŒ')
        for column in df:
            column_length = max(df[column].astype(str).map(len).max(), len(column)) + 2
            col_idx = df.columns.get_loc(column)
            writer.sheets['ØªØ­Ù„ÛŒÙ„_Ù†ÙˆØ¢ÙˆØ±ÛŒ'].set_column(col_idx, col_idx, column_length)
    processed_data = output.getvalue()
    return processed_data


# --- Streamlit App UI ---

st.title("ğŸ’¡ ØªØ­Ù„ÛŒÙ„Ú¯Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù†ÙˆØ¢ÙˆØ±ÛŒ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§")
st.markdown("Ø§ÛŒÙ† Ø§Ø¨Ø²Ø§Ø± Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Gemini Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ **Ù…Ø¯Ù„ Ø±ØªØ¨Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù†ÙˆØ¢ÙˆØ±ÛŒ**ØŒ Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§ Ø±Ø§ ØªØ­Ù„ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.")

st.sidebar.header("ØªÙ†Ø¸ÛŒÙ…Ø§Øª")
api_key = st.sidebar.text_input("ğŸ”‘ Ú©Ù„ÛŒØ¯ API Ú¯ÙˆÚ¯Ù„ Gemini Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", type="password", help="Ú©Ù„ÛŒØ¯ API Ø´Ù…Ø§ Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯ Ùˆ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¬Ù„Ø³Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.")

if not api_key:
    st.warning("Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ØªØ­Ù„ÛŒÙ„ØŒ Ú©Ù„ÛŒØ¯ API Ú¯ÙˆÚ¯Ù„ Gemini Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.")
    st.stop()

try:
    genai.configure(api_key=api_key)
    model = genai.GenerativeModel('gemini-1.5-flash-latest')
except Exception as e:
    st.error(f"âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… Ú©Ù„ÛŒØ¯ API: Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ú©Ù„ÛŒØ¯ Ø®ÙˆØ¯ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø­Ø§ØµÙ„ Ú©Ù†ÛŒØ¯.")
    st.stop()

uploaded_file = st.file_uploader("ğŸ“‚ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ø­Ø§ÙˆÛŒ Ø¹Ù†Ø§ÙˆÛŒÙ† Ùˆ Ú†Ú©ÛŒØ¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯", type=["xlsx"])

if uploaded_file is not None:
    try:
        df = pd.read_excel(uploaded_file)
        st.success("âœ… ÙØ§ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯. Ù„Ø·ÙØ§ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯.")
        st.dataframe(df.head())

        st.sidebar.header("Ø§Ù†ØªØ®Ø§Ø¨ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§")
        columns = df.columns.tolist()
        title_col = st.sidebar.selectbox("Ø³ØªÙˆÙ† Ø­Ø§ÙˆÛŒ **Ø¹Ù†ÙˆØ§Ù†** Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", columns, index=0)
        abstract_col = st.sidebar.selectbox("Ø³ØªÙˆÙ† Ø­Ø§ÙˆÛŒ **Ú†Ú©ÛŒØ¯Ù‡** Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:", columns, index=1 if len(columns) > 1 else 0)

        if st.button("ğŸš€ Ø´Ø±ÙˆØ¹ ØªØ­Ù„ÛŒÙ„", type="primary"):
            if title_col == abstract_col:
                st.error("Ø³ØªÙˆÙ† Ø¹Ù†ÙˆØ§Ù† Ùˆ Ú†Ú©ÛŒØ¯Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ ÛŒÚ©Ø³Ø§Ù† Ø¨Ø§Ø´Ù†Ø¯.")
            else:
                with st.spinner("Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„... Ø§ÛŒÙ† ÙØ±Ø¢ÛŒÙ†Ø¯ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø¨Ø³ØªÙ‡ Ø¨Ù‡ ØªØ¹Ø¯Ø§Ø¯ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ Ø²Ù…Ø§Ù†â€ŒØ¨Ø± Ø¨Ø§Ø´Ø¯."):
                    progress_bar = st.progress(0, text="Ø´Ø±ÙˆØ¹ ÙØ±Ø¢ÛŒÙ†Ø¯ ØªØ­Ù„ÛŒÙ„...")
                    total_rows = len(df)
                    results = []

                    for i, row in df.iterrows():
                        title = str(row.get(title_col, ''))
                        abstract = str(row.get(abstract_col, ''))

                        if not title or not abstract:
                            results.append({
                                "Ø­ÙˆØ²Ù‡ Ø¹Ù„Ù…ÛŒ": "N/A", "ÙÙ†Ø§ÙˆØ±ÛŒ Ø®Ø§Øµ": "N/A", "Ø­Ù„ Ù…Ø³Ø¦Ù„Ù‡": "N/A",
                                "ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ": "N/A", "Ù‡Ù…Ú©Ø§Ø±ÛŒ": "N/A", "Ù†Ù…Ø±Ù‡ Ù†Ù‡Ø§ÛŒÛŒ": "N/A",
                                "Ù¾ØªØ§Ù†Ø³ÛŒÙ„ Ù†ÙˆØ¢ÙˆØ±ÛŒ": "N/A", "ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ": "Ø¹Ù†ÙˆØ§Ù† ÛŒØ§ Ú†Ú©ÛŒØ¯Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª."
                            })
                        else:
                            prompt = create_prompt(title, abstract)
                            # --- Ø´Ø±ÙˆØ¹ Ø¨Ù„ÙˆÚ© ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ ---
                            max_retries = 5
                            retry_delay = 2  # Ø«Ø§Ù†ÛŒÙ‡
                            for attempt in range(max_retries):
                                try:
                                    response = model.generate_content(prompt)
                                    parsed_data = parse_response(response.text)
                                    results.append(parsed_data)
                                    break  # Ø¯Ø± ØµÙˆØ±Øª Ù…ÙˆÙÙ‚ÛŒØªØŒ Ø§Ø² Ø­Ù„Ù‚Ù‡ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
                                
                                except google.api_core.exceptions.ResourceExhausted as e:
                                    if attempt < max_retries - 1:
                                        st.warning(f"Ù…Ø­Ø¯ÙˆØ¯ÛŒØª API Ø¯Ø± Ø±Ø¯ÛŒÙ {i+1}. ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ ØªØ§ {retry_delay} Ø«Ø§Ù†ÛŒÙ‡ Ø¯ÛŒÚ¯Ø±...")
                                        sleep(retry_delay)
                                        retry_delay *= 2  # Ø§ÙØ²Ø§ÛŒØ´ Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ ØªÙ„Ø§Ø´ Ø¨Ø¹Ø¯ÛŒ
                                    else:
                                        st.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ÛŒÙ {i+1} Ù¾Ø³ Ø§Ø² {max_retries} ØªÙ„Ø§Ø´: Ù…Ø­Ø¯ÙˆØ¯ÛŒØª API Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø§Ø±Ø¯.")
                                        results.append({"ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ": "Ø®Ø·Ø§: Ù…Ø­Ø¯ÙˆØ¯ÛŒØª API"})
                                        break # Ø§Ú¯Ø± Ø¨Ø¹Ø¯ Ø§Ø² Ù‡Ù…Ù‡ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ Ø¨Ø§Ø² Ù‡Ù… Ø®Ø·Ø§ Ø¯Ø§Ø¯ØŒ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
                                except Exception as e:
                                    st.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø±Ø¯ÛŒÙ {i+1}: {e}")
                                    results.append({"ØªØ­Ù„ÛŒÙ„ Ú©Ù„ÛŒ": f"Ø®Ø·Ø§: {e}"})
                                    break # Ø¯Ø± ØµÙˆØ±Øª Ø¨Ø±ÙˆØ² Ø®Ø·Ø§ÛŒ Ø¯ÛŒÚ¯Ø±ØŒ Ø§Ø² Ø­Ù„Ù‚Ù‡ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
                            # --- Ù¾Ø§ÛŒØ§Ù† Ø¨Ù„ÙˆÚ© ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ ---
                        
                        # ØªØ£Ø®ÛŒØ± Ø«Ø§Ø¨Øª Ø¨ÛŒÙ† Ù‡Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÙˆÙÙ‚ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ÙØ´Ø§Ø± Ø±ÙˆÛŒ API
                        sleep(1) 
                        progress_bar.progress((i + 1) / total_rows, text=f"Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø±Ø¯ÛŒÙ {i+1} Ø§Ø² {total_rows}")
                    
                st.success("ğŸ‰ ØªØ­Ù„ÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!")

                results_df = pd.DataFrame(results)
                results_df.rename(columns={
                    "Ø­ÙˆØ²Ù‡ Ø¹Ù„Ù…ÛŒ": "Ø§Ù…ØªÛŒØ§Ø² Ø­ÙˆØ²Ù‡ Ø¹Ù„Ù…ÛŒ", "ÙÙ†Ø§ÙˆØ±ÛŒ Ø®Ø§Øµ": "Ø§Ù…ØªÛŒØ§Ø² ÙÙ†Ø§ÙˆØ±ÛŒ Ø®Ø§Øµ",
                    "Ø­Ù„ Ù…Ø³Ø¦Ù„Ù‡": "Ø§Ù…ØªÛŒØ§Ø² Ø­Ù„ Ù…Ø³Ø¦Ù„Ù‡", "ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ": "Ø§Ù…ØªÛŒØ§Ø² ØªØ¬Ø§Ø±ÛŒâ€ŒØ³Ø§Ø²ÛŒ",
                    "Ù‡Ù…Ú©Ø§Ø±ÛŒ": "Ø§Ù…ØªÛŒØ§Ø² Ù‡Ù…Ú©Ø§Ø±ÛŒ",
                }, inplace=True)
                
                final_df = pd.concat([df, results_df], axis=1)
                st.dataframe(final_df)

                excel_data = to_excel(final_df)
                st.download_button(
                    label="ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„ Ù†ØªØ§ÛŒØ¬",
                    data=excel_data,
                    file_name="ØªØ­Ù„ÛŒÙ„_Ù†ÙˆØ¢ÙˆØ±ÛŒ_Ù¾Ø§ÛŒØ§Ù†â€ŒÙ†Ø§Ù…Ù‡â€ŒÙ‡Ø§.xlsx",
                    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                )
    except Exception as e:
        st.error(f"Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ø§Ú©Ø³Ù„: {e}")
