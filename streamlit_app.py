import streamlit as st

st.title("ุฏุงุดุจูุฑุฏ ุชุญูู ูพุงุงูโูุงููโูุง ุนููู ูพุฒุดฺฉ ุจุง Gemini ")
st.write(
    "Let's start building! For help and inspiration, head over to [docs.streamlit.io](https://docs.streamlit.io/)."
)
# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import json
import asyncio
import httpx  # For making asynchronous HTTP requests

# -----------------------------------------------------------------------------
# ุชูุธูุงุช ุตูุญู
# -----------------------------------------------------------------------------
st.set_page_config(layout="wide", page_title="ุฏุงุดุจูุฑุฏ ุชุญูู ูพุงุงูโูุงููโูุง ุนููู ูพุฒุดฺฉ ุจุง Gemini")

# -----------------------------------------------------------------------------
# ุชุนุฑู ุดุงุฎุตโูุง ุงุฑุฒุงุจ (ุจุฏูู ฺฉูุฏูุงฺู)
# -----------------------------------------------------------------------------
# ฺฉูุฏูุงฺูโูุง ุญุฐู ุดุฏูโุงูุฏ ฺูู ุชุญูู ุจู ุทูุฑ ฺฉุงูู ุชูุณุท ูุฏู Gemini ุงูุฌุงู ูโุดูุฏ.
ANALYSIS_CRITERIA = {
    "ุญูุฒู ุนูู": {
        "labels": ["ูพุฒุดฺฉ ุจุงูู", "ุฏูุฏุงููพุฒุดฺฉ", "ุฏุงุฑูุณุงุฒ", "ุนููู ูพุงู ูพุฒุดฺฉ", "ุจูุฏุงุดุช ู ุงูพุฏููููฺ", "ูพุฑุณุชุงุฑ ู ูุงูุง", "ุชูุงูุจุฎุด ู ูพุฑุงูพุฒุดฺฉ"],
    },
    "ููุงูุฑ ุง ููุขูุฑ ุฎุงุต": {
        "labels": ["ููุด ูุตููุน ุฏุฑ ูพุฒุดฺฉ", "ูููุฏุณ ุจุงูุช ู ุณูููโูุง ุจูุงุฏ", "ุชุฌูุฒุงุช ูพุฒุดฺฉ ูพุดุฑูุชู", "ูพุฒุดฺฉ ุงุฒ ุฑุงู ุฏูุฑ (Telemedicine)", "ฺูโุฏุฑูุงู ู ูพุฒุดฺฉ ุดุฎุตโุณุงุฒโุดุฏู", "ูุงููุชฺฉููููฺ ุฏุงุฑู", "ุจุฏูู ููุขูุฑ ุฎุงุต"],
    },
    "ุญู ูุณุฆูู ุตูุนุช/ุงุฌุชูุงุน": {
        "labels": ["ุชุดุฎุต ู ุฏุฑูุงู ุจูุงุฑโูุง", "ุชูุณุนู ุฏุงุฑููุง ู ูุงฺฉุณูโูุง", "ุงุฑุชูุงุก ุณูุงูุช ุนููู", "ุจูุจูุฏ ูุฏุฑุช ูุธุงู ุณูุงูุช", "ููุขูุฑ ุฏุฑ ุชุฌูุฒุงุช ูพุฒุดฺฉ", "ูุงูุฏ ูุณุฆูู ูุดุฎุต"],
    },
    "ูุงุจูุช ุชุฌุงุฑโุณุงุฒ": {
        "labels": ["ูพุชุงูุณู ุจุงูุง", "ูพุชุงูุณู ูุชูุณุท", "ูพุชุงูุณู ฺฉู"],
    },
    "ููฺฉุงุฑ ุจุง ุตูุนุช/ููุงุฏ ุบุฑุฏุงูุดฺฏุงู": {
        "labels": ["ุฏุงุฑุง ููฺฉุงุฑ", "ุจุฏูู ููฺฉุงุฑ"],
    }
}

# -----------------------------------------------------------------------------
# ุชูุงุจุน ุงุตู ุจุฑุง ูพุฑุฏุงุฒุด ู ุชุญูู ุจุง Gemini
# -----------------------------------------------------------------------------

async def call_gemini_api(prompt):
    """
    ฺฉ ูุฑุงุฎูุงู API ูุงููุฒูุงู ุจู ูุฏู Gemini ุงุฑุณุงู ูโฺฉูุฏ.
    """
    # URL ุจุฑุง ุฏุณุชุฑุณ ุจู ูุฏู Gemini Flash ุจุฏูู ูุงุฒ ุจู ฺฉูุฏ (ุทุจู ุฏุณุชูุฑุงูุนูู ูุญุท)
    api_url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key="
    
    payload = {
        "contents": [{"parts": [{"text": prompt}]}],
        "generationConfig": {
            "temperature": 0.1,
            "topP": 0.95,
            "maxOutputTokens": 50,
        }
    }
    
    headers = {'Content-Type': 'application/json'}
    
    # ุงุณุชูุงุฏู ุงุฒ httpx ุจุฑุง ุงุฑุณุงู ุฏุฑุฎูุงุณุชโูุง ูุงููุฒูุงู
    async with httpx.AsyncClient(timeout=60.0) as client:
        try:
            # ุงุฑุณุงู ุฏุฑุฎูุงุณุช ุจู API
            response = await client.post(api_url, json=payload, headers=headers)
            response.raise_for_status()  # ุงุฌุงุฏ ุฎุทุง ุฏุฑ ุตูุฑุช ูพุงุณุฎ ูุงูููู (e.g., 4xx or 5xx)
            result = response.json()
            
            # ุงุณุชุฎุฑุงุฌ ูุชู ุงุฒ ูพุงุณุฎ ุฏุฑุงูุช
            if (result.get('candidates') and 
                result['candidates'][0].get('content') and 
                result['candidates'][0]['content'].get('parts')):
                
                text_response = result['candidates'][0]['content']['parts'][0].get('text', '').strip()
                return text_response
            else:
                # ูุฏุฑุช ูพุงุณุฎโูุง ูุงูุนุชุจุฑ ุง ูุณุฏูุฏ ุดุฏู
                error_info = result.get('promptFeedback', 'ุฌุฒุฆุงุช ููุฌูุฏ ูุณุช.')
                st.warning(f"ูพุงุณุฎ ููุฑุฏ ุงูุชุธุงุฑ ุงุฒ ูุฏู ุฏุฑุงูุช ูุดุฏ. ุฏูู: {error_info}")
                return None

        except httpx.RequestError as e:
            st.error(f"ุฎุทุง ุฏุฑ ุจุฑูุฑุงุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุณ Gemini: {e}")
            return None
        except Exception as e:
            st.error(f"ุฎุทุง ุบุฑููุชุธุฑู ุฏุฑ ููฺฏุงู ูุฑุงุฎูุงู API: {e}")
            return None


async def analyze_text_with_gemini(text, criterion_name, labels, default_label):
    """
    ูุชู ุฑุง ุจุง ุงุณุชูุงุฏู ุงุฒ ูุฏู Gemini ู ฺฉ ูพุฑุงููพุช ุณุงุฎุชุงุฑุงูุชู ุชุญูู ูโฺฉูุฏ.
    """
    # ุณุงุฎุช ฺฉ ูพุฑุงููพุช (ุฏุณุชูุฑ) ุฏูู ุจุฑุง ูุฏุงุช ูุฏู ุจู ุณูุช ูพุงุณุฎ ูุทููุจ
    prompt = f"""
    ุดูุง ฺฉ ุฏุณุชุงุฑ ูุชุฎุตุต ุฏุฑ ุชุญูู ูุชูู ุนูู ู ูพุงุงูโูุงููโูุง ุญูุฒู ุนููู ูพุฒุดฺฉ ูุณุชุฏ.
    ูุชู ุฒุฑ ฺฉู ุดุงูู ุนููุงู ู ฺฺฉุฏู ฺฉ ูพุงุงูโูุงูู ุงุณุช ุฑุง ุจุง ุฏูุช ุชุญูู ฺฉูุฏ.
    ูุธูู ุดูุง ุงู ุงุณุช ฺฉู ุจุฑ ุงุณุงุณ ูุญุชูุง ูุชูุ ูุดุฎุต ฺฉูุฏ ุงู ูพุงุงูโูุงูู ุจู ฺฉุฏุงู ฺฉ ุงุฒ ุฏุณุชูโูุง ุฒุฑ ุฏุฑ ุดุงุฎุต ยซ{criterion_name}ยป ุชุนูู ุฏุงุฑุฏ.

    ุฏุณุชูโูุง ููฺฉู:
    - {', '.join(labels)}

    ูุทูุงู ููุท ู ููุท ูุงู ุฏูู ฺฉ ุงุฒ ุฏุณุชูโูุง ุจุงูุง ุฑุง ุจู ุนููุงู ูพุงุณุฎ ุฎุฑูุฌ ุฏูุฏ. ูฺ ุชูุถุญ ุงุถุงููโุง ูุฏูุฏ.

    ูุชู ูพุงุงูโูุงูู:
    ---
    {text}
    ---
    """
    
    response_text = await call_gemini_api(prompt)
    
    # ูพุงฺฉโุณุงุฒ ู ุงุนุชุจุงุฑุณูุฌ ูพุงุณุฎ ุจุฑุง ุงุทููุงู ุงุฒ ุชุทุงุจู ุจุง ุฏุณุชูโูุง ููุฌูุฏ
    if response_text:
        cleaned_response = response_text.replace("*", "").strip()
        if cleaned_response in labels:
            return cleaned_response
    
    return default_label


async def process_theses_async(df):
    """
    ุฏุชุงูุฑู ูุฑูุฏ ุฑุง ุจู ุตูุฑุช ูุงููุฒูุงู ูพุฑุฏุงุฒุด ฺฉุฑุฏู ู ูุชุงุฌ ุชุญูู ุฑุง ุจุฑูโฺฏุฑุฏุงูุฏ.
    """
    results = []
    progress_bar = st.progress(0, text="ุฏุฑ ุญุงู ุขูุงุฏูโุณุงุฒ ุจุฑุง ุชุญูู...")
    total_rows = len(df)
    
    for index, row in df.iterrows():
        title = str(row.get("ุนููุงู", ""))
        abstract = str(row.get("ฺฺฉุฏู", ""))
        
        if not title or not abstract:
            continue
            
        full_text = f"ุนููุงู: {title}\nฺฺฉุฏู: {abstract}"
        analysis_result = {"ุนููุงู": title}
        
        # ุงุฌุงุฏ ุชุณฺฉโูุง ูุงููุฒูุงู ุจุฑุง ูุฑ ุดุงุฎุต ุงุฒ ฺฉ ูพุงุงูโูุงูู
        tasks = []
        for criterion, data in ANALYSIS_CRITERIA.items():
            default_label = "ูุงูุดุฎุต"
            if criterion == "ููุงูุฑ ุง ููุขูุฑ ุฎุงุต": default_label = "ุจุฏูู ููุขูุฑ ุฎุงุต"
            elif criterion == "ุญู ูุณุฆูู ุตูุนุช/ุงุฌุชูุงุน": default_label = "ูุงูุฏ ูุณุฆูู ูุดุฎุต"
            elif criterion == "ูุงุจูุช ุชุฌุงุฑโุณุงุฒ": default_label = "ูพุชุงูุณู ฺฉู"
            elif criterion == "ููฺฉุงุฑ ุจุง ุตูุนุช/ููุงุฏ ุบุฑุฏุงูุดฺฏุงู": default_label = "ุจุฏูู ููฺฉุงุฑ"
            
            task = analyze_text_with_gemini(full_text, criterion, data["labels"], default_label)
            tasks.append(task)
        
        # ุงุฌุฑุง ููุฒูุงู ุชุณฺฉโูุง ุจุฑุง ฺฉ ูพุงุงูโูุงูู ู ุฌูุนโุขูุฑ ูุชุงุฌ
        analyzed_labels = await asyncio.gather(*tasks)
        
        for i, criterion in enumerate(ANALYSIS_CRITERIA.keys()):
            analysis_result[criterion] = analyzed_labels[i]
            
        results.append(analysis_result)
        
        # ุจูโุฑูุฒุฑุณุงู ููุงุฑ ูพุดุฑูุช
        progress_text = f"ุฏุฑ ุญุงู ุชุญูู ูพุงุงูโูุงูู {index + 1} ุงุฒ {total_rows}..."
        progress_bar.progress((index + 1) / total_rows, text=progress_text)

    progress_bar.empty()
    return pd.DataFrame(results)

# -----------------------------------------------------------------------------
# ุฑุงุจุท ฺฉุงุฑุจุฑ ุฏุงุดุจูุฑุฏ (Streamlit UI)
# -----------------------------------------------------------------------------

st.title("โ๏ธ ุฏุงุดุจูุฑุฏ ุชุญูู ูพุงุงูโูุงููโูุง ุนููู ูพุฒุดฺฉ ุจุง Gemini")
st.markdown("""
ุงู ุงุจุฒุงุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ ูุฏู ููุด ูุตููุน **Gemini 2.5 Flash**ุ ูพุชุงูุณู ูพุงุงูโูุงููโูุง ุญูุฒู ุนููู ูพุฒุดฺฉ ุฑุง ุจุฑ ุงุณุงุณ ุดุงุฎุตโูุง ุชุฎุตุต ุงุฑุฒุงุจ ูโฺฉูุฏ.

**ุฑุงูููุง:**
1.  ฺฉ ูุงู ุงฺฉุณู (`.xlsx` ุง `.xls`) ุดุงูู ุณุชููโูุง **`ุนููุงู`** ู **`ฺฺฉุฏู`** ุขูุงุฏู ฺฉูุฏ.
2.  ูุงู ุฑุง ุงุฒ ุทุฑู ุฏฺฉูู ุฒุฑ ุจุงุฑฺฏุฐุงุฑ ฺฉุฑุฏู ู ุฑู ุฏฺฉูู ุชุญูู ฺฉูฺฉ ฺฉูุฏ.
""")

uploaded_file = st.file_uploader("ูุงู ุงฺฉุณู ุฎูุฏ ุฑุง ุงูุฌุง ุจุงุฑฺฏุฐุงุฑ ฺฉูุฏ", type=["xlsx", "xls"])

if uploaded_file:
    try:
        df = pd.read_excel(uploaded_file)

        if "ุนููุงู" not in df.columns or "ฺฺฉุฏู" not in df.columns:
            st.error("ุฎุทุง: ูุงู ุงฺฉุณู ุจุงุฏ ุญุชูุงู ุดุงูู ุณุชููโูุง 'ุนููุงู' ู 'ฺฺฉุฏู' ุจุงุดุฏ.")
        else:
            st.success(f"ูุงู ุจุง ููููุช ุจุงุฑฺฏุฐุงุฑ ุดุฏ. **{len(df)}** ูพุงุงูโูุงูู ุจุฑุง ุชุญูู ุดูุงุณุง ุดุฏ.")
            st.markdown("### ูพุดโููุงุด ุฏุงุฏูโูุง ูุฑูุฏ")
            st.dataframe(df.head())

            if st.button("๐ฌ ุดุฑูุน ุชุญูู ุจุง Gemini", type="primary", use_container_width=True):
                with st.spinner("ูุทูุงู ุตุจุฑ ฺฉูุฏ... ุฏุฑ ุญุงู ุงุฑุชุจุงุท ุจุง ุณุฑูุฑูุง Gemini ู ุชุญูู ุฏุงุฏูโูุง... ุงู ูุฑุขูุฏ ููฺฉู ุงุณุช ุฒูุงูโุจุฑ ุจุงุดุฏ."):
                    # ุงุฌุฑุง ุชุงุจุน ูุงููุฒูุงู ุงุตู
                    result_df = asyncio.run(process_theses_async(df))
                
                st.balloons()
                st.markdown("---")
                st.markdown("### ูุชุงุฌ ููุง ุชุญูู")
                
                column_order = ["ุนููุงู"] + list(ANALYSIS_CRITERIA.keys())
                result_df = result_df[column_order]

                st.dataframe(result_df)

                csv = result_df.to_csv(index=False).encode('utf-8-sig')
                st.download_button(
                    label="๐ฅ ุฏุงูููุฏ ูุชุงุฌ ุฏุฑ ูุงูุจ CSV",
                    data=csv,
                    file_name='tahlil_gemini_olom_pezeshki.csv',
                    mime='text/csv',
                    use_container_width=True
                )

    except Exception as e:
        st.error(f"ฺฉ ุฎุทุง ุบุฑููุชุธุฑู ุฏุฑ ูพุฑุฏุงุฒุด ูุงู ุฑุฎ ุฏุงุฏ: {e}")
else:
    st.info("ููุชุธุฑ ุจุงุฑฺฏุฐุงุฑ ูุงู ุงฺฉุณู ุดูุง ูุณุชู...")
